# PRD

**项目名称**：运维巡检平台
**编写日期**：2024 年 11 月
**版本号**：1.2
**作者**：周伟军

## 一、背景和目标

随着企业规模的扩大，服务器的监控和运维管理需求不断增加。基于夜莺监控系统（Nightingale）和 VictoriaMetrics 数据库，现有的监控数据收集和管理存在一定的复杂性，且手动生成巡检报告效率较低。因此，我们需要开发一个自动化的运维巡检平台，简化巡检报告的生成流程，减少人工干预，提高效率，并通过容器化部署提升平台的可扩展性。

核心目标：

- 自动化生成巡检报告，支持时间范围和标签过滤。
- 提供灵活、便捷的查询界面，生成可下载的报告（支持 Excel 和 PDF 格式）。
- 支持多项目、分标签生成报告，能够按项目分表展示数据。
- 支持容器化部署，兼容 Docker 和 Kubernetes 环境。

## 二、产品功能

### 2.1 数据集成与配置

- **数据源集成**：与现有的夜莺监控系统和 VictoriaMetrics 数据源无缝集成，使用 PromQL 查询监控数据，支持查询并计算 CPU、内存、磁盘、网络等基础指标。
- **标签管理**：利用已有的集群标签（如 `chongqing`）对数据进行过滤，生成该标签下集群的巡检报告。

### 2.2 自动化巡检报告生成

- **时间范围选择**：支持选择不同时间范围生成报告，包括“最近一天”、“最近一周”、“最近一个月”，并支持自定义日期范围。
- **数据查询与分析**：平台自动从 VictoriaMetrics 查询并计算监控数据，生成报告。数据计算包括：
  - CPU 使用率
  - 内存使用情况
  - 磁盘空间使用
  - 网络流量
  - 系统负载等
- **报告内容**：每份报告将包括：
  - 主机名
  - IP 地址
  - 各项监控指标（如 CPU 使用率、内存、磁盘等）
  - 健康状态（是否满足预设标准）
  - 告警信息（若有异常）

### 2.3 Excel 报告支持

- **项目分表**：每个项目（如 `chongqing`）生成一个单独的工作表。每个工作表包括该项目下所有主机的详细巡检数据。
- **报告格式**：报告列标题包括主机名、IP 地址、监控指标、健康状态、告警信息等。
- **汇总表**：可生成一个汇总表，列出所有项目的统计数据，如平均 CPU 使用率、内存使用率等。

### 2.4 用户操作和界面设计

- **简洁的操作界面**：平台应提供简洁的界面，支持选择时间范围、标签、监控项等生成报告。
- **自动化巡检任务**：支持设置定期自动化巡检任务，系统按时自动生成报告并发送邮件或通知。
- **报告预览与下载**：用户可以预览报告内容，确认无误后进行下载（支持 PDF 和 Excel 格式）。

### 2.5 监控与告警

- **异常监控**：用户可设置告警规则，平台自动识别并在报告中突出显示异常数据。
- **告警报告**：报告中应包括异常指标的详细信息，并为运维人员提供可能的处理建议。

## 三、技术需求

### 3.1 系统架构

- **后端技术栈**：
  - **开发语言**：Go
  - **Web 框架**：Gin
  - **数据库**：MySQL，存储巡检历史数据及配置
  - **容器化**：支持 Docker 和 Kubernetes 部署，保证平台的灵活性和可扩展性。
- **前端技术栈**：
  - **前端框架**：Vue.js
  - **界面设计**：简洁且响应式，支持多设备访问。
- **数据存储**：
  - **数据库**：MySQL，用于存储巡检历史数据、用户配置和任务信息。

### 3.2 数据库设计

#### 主要表结构设计

1. **hosts（主机信息表）**

   - `id` (INT, 主键，自增)
   - `host_name` (VARCHAR, 主机名)
   - `ip_address` (VARCHAR, IP 地址)
   - `project_tag` (VARCHAR, 项目标签，如 "chongqing")
   - `status` (ENUM, 状态，如 "active"、"inactive")
   - `created_at` (DATETIME, 创建时间)
   - `updated_at` (DATETIME, 更新时间)

2. **monitoring_data（监控数据表）**
   - `id` (INT, 主键，自增)
   - `host_id` (INT, 外键关联 `hosts.id`)
   - `metric` (VARCHAR, 监控项，如 "cpu_usage"、"memory_usage")
   - `value` (FLOAT, 数据值)
   - `timestamp` (DATETIME, 数据记录时间)
   - `report_generated` (BOOLEAN, 是否生成报告)
3. **reports（巡检报告表）**

   - `id` (INT, 主键，自增)
   - `host_id` (INT, 外键关联 `hosts.id`)
   - `project_tag` (VARCHAR, 项目标签)
   - `report_date` (DATE, 报告生成日期)
   - `status` (ENUM, 健康状态，如 "healthy"、"warning"、"critical")
   - `report_file` (VARCHAR, 报告文件路径)
   - `created_at` (DATETIME, 创建时间)

4. **users（用户表）**

   - `id` (INT, 主键，自增)
   - `username` (VARCHAR, 用户名)
   - `password` (VARCHAR, 加密后的密码)
   - `role` (ENUM, 角色，如 "admin"、"operator")
   - `email` (VARCHAR, 用户邮箱)
   - `created_at` (DATETIME, 创建时间)

5. **tasks（定时巡检任务表）**
   - `id` (INT, 主键，自增)
   - `task_name` (VARCHAR, 任务名称)
   - `frequency` (ENUM, 频率，如 "daily"、"weekly"、"monthly")
   - `next_run_time` (DATETIME, 下次执行时间)
   - `status` (ENUM, 任务状态，如 "active"、"inactive")
   - `created_at` (DATETIME, 创建时间)

## 四、用户角色与权限

- **管理员**：
  - 创建、管理巡检任务；
  - 管理用户权限；
  - 查看所有生成的巡检报告。
- **运维人员**：

  - 查看自己的巡检报告；
  - 配置并生成巡检报告；
  - 设置告警规则。

- **普通用户**：
  - 只能查看自己的巡检报告，无法配置或管理任务。

## 五、非功能性需求

- **性能**：平台应支持高并发查询和报告生成，保证用户体验流畅。
- **可扩展性**：系统架构应支持未来的功能扩展，如增加更多监控项、集成更多数据源。
- **安全性**：平台必须具备强密码保护、权限控制等安全机制。
- **容错性**：平台应具备高可用性和自动恢复功能。

## 六、时间线与开发计划

| 阶段         | 任务描述                                                  | 完成时间   |
| ------------ | --------------------------------------------------------- | ---------- |
| **需求分析** | 完成产品需求文档，确认核心功能与需求                      | 2024-11-20 |
| **原型设计** | 设计 UI/UX 原型，确认产品界面和交互流程                   | 2024-11-30 |
| **系统开发** | 开发后端（Go + Gin），前端（Vue），并进行数据库设计与实现 | 2025-01-15 |
| **功能测试** | 进行全面的功能测试、性能优化、修复 Bug                    | 2025-01-30 |
| **上线准备** | 完成文档、用户培训，进行上线部署                          | 2025-02-10 |

## 七、风险与挑战

- **数据延迟**：从 VictoriaMetrics 获取数据时可能存在延迟，需要优化查询性能。
- **系统扩展性**：在多项目和多标签的情况下，系统可能面临性能瓶颈，需提前考虑扩展。
- **告警准确性**：确保监控数据的准确性，避免误报和漏报。

## 八、结语

该运维巡检平台旨在通过自动化、集成化和智能化的方式，提升运维工作的效率和准确性，减少人工操作和巡检的工作负担，为运维人员提供更加高效和精准的工具。
